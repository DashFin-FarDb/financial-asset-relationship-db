version: 2.1

orbs:
  node: circleci/node@5.1.0
  python: circleci/python@2.1.1
  codecov: codecov/codecov@4.0.1

executors:
  python-executor:
    docker:
      - image: cimg/python:3.11
    working_directory: ~/project
    resource_class: medium

  node-executor:
    docker:
      - image: cimg/node:25.6.1
    working_directory: ~/project
    resource_class: medium

jobs:
  # Python Backend Jobs
  python-lint:
    executor: python-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - python-deps-v2-{{ checksum "requirements.txt" }}-{{ checksum "requirements-dev.txt" }}
            - python-deps-v2-{{ checksum "requirements.txt" }}
            - python-deps-v2-
      - run:
          name: Install dependencies
          command: |
            pip install --upgrade pip
            pip install -r requirements.txt
            if [ -f requirements-dev.txt ]; then
              pip install -r requirements-dev.txt
            fi
      - save_cache:
          key: python-deps-v2-{{ checksum "requirements.txt" }}-{{ checksum "requirements-dev.txt" }}
          paths:
            - ~/.cache/pip
      - run:
          name: Run flake8 (critical errors only)
          command: |
            flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --config=.flake8

  python-test:
    executor: python-executor
    parallelism: 4
    steps:
      - checkout
      - restore_cache:
          keys:
            - python-deps-v2-{{ checksum "requirements.txt" }}-{{ checksum "requirements-dev.txt" }}
            - python-deps-v2-{{ checksum "requirements.txt" }}
            - python-deps-v2-
      - run:
          name: Install dependencies
          command: |
            pip install --upgrade pip
            pip install -r requirements.txt
            if [ -f requirements-dev.txt ]; then
              pip install -r requirements-dev.txt
            fi
      - save_cache:
          key: python-deps-v2-{{ checksum "requirements.txt" }}-{{ checksum "requirements-dev.txt" }}
          paths:
            - ~/.cache/pip
      - run:
          name: Run tests with pytest
          command: |
            # Split tests using CircleCI's intelligent test splitting
            TESTFILES=$(circleci tests glob "tests/**/test_*.py" | circleci tests split --split-by=timings)
            pytest $TESTFILES --cov=src --cov-report=xml --cov-report=html --cov-report=term-missing -v --junitxml=test-results/pytest/results.xml
      - codecov/upload:
          file: coverage.xml
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: htmlcov
          destination: coverage-report

  python-security:
    executor: python-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - python-deps-v2-{{ checksum "requirements.txt" }}-{{ checksum "requirements-dev.txt" }}
            - python-deps-v2-{{ checksum "requirements.txt" }}
            - python-deps-v2-
      - restore_cache:
          keys:
            - security-tools-v1
      - run:
          name: Install dependencies
          command: |
            pip install --upgrade pip
            pip install -r requirements.txt
            pip install safety bandit
            if [ -f requirements-dev.txt ]; then
              pip install -r requirements-dev.txt
            fi
      - save_cache:
          key: security-tools-v1
          paths:
            - ~/.cache/pip
      - run:
          name: Security check with safety
          command: safety check --json --ignore 72086
      - run:
          name: Security check with bandit
          command: bandit -r src/ -ll -f json -o bandit-report.json
      - store_artifacts:
          path: bandit-report.json
          destination: security-reports

  # Frontend Jobs
  frontend-lint:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - node-deps-v2-{{ checksum "frontend/package-lock.json" }}
            - node-deps-v2-{{ checksum "frontend/package.json" }}
            - node-deps-v2-
      - run:
          name: Install dependencies
          command: |
            cd frontend
            if [ -f package-lock.json ]; then
              npm ci --prefer-offline --no-audit
            else
              echo "package-lock.json not found; running npm install instead"
              npm install
            fi
      - save_cache:
          key: node-deps-v2-{{ checksum "frontend/package-lock.json" }}
          paths:
            - frontend/node_modules
            - ~/.npm
      - run:
          name: Run ESLint
          command: |
            cd frontend && npm run lint --if-present

  frontend-build:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - node-deps-v2-{{ checksum "frontend/package-lock.json" }}
            - node-deps-v2-{{ checksum "frontend/package.json" }}
            - node-deps-v2-
      - run:
          name: Install dependencies
          command: |
            cd frontend
            if [ -f package-lock.json ]; then
              npm ci --prefer-offline --no-audit
            else
              echo "package-lock.json not found; running npm install instead"
              npm install
            fi
      - save_cache:
          key: node-deps-v2-{{ checksum "frontend/package-lock.json" }}
          paths:
            - frontend/node_modules
            - ~/.npm
      - restore_cache:
          keys:
            - nextjs-cache-v1-{{ .Branch }}-{{ .Revision }}
            - nextjs-cache-v1-{{ .Branch }}-
            - nextjs-cache-v1-
      - run:
          name: Build Next.js application
          command: |
            cd frontend && npm run build --if-present
      - save_cache:
          key: nextjs-cache-v1-{{ .Branch }}-{{ .Revision }}
          paths:
            - frontend/.next/cache
      - store_artifacts:
          path: frontend/.next
          destination: next-build

  # Docker Build Job
  docker-build:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build Docker image
          command: |
            docker build -t financial-asset-relationship-db:${CIRCLE_SHA1} .
      - run:
          name: Test Docker image
          command: |
            docker run --rm financial-asset-relationship-db:${CIRCLE_SHA1} python --version

workflows:
  version: 2
  build-and-test:
    jobs:
      # Backend workflow - run lint and test in parallel for faster feedback
      - python-lint
      - python-test
      - python-security:
          requires:
            - python-lint
            - python-test

      # Frontend workflow - run lint and build in parallel
      - frontend-lint
      - frontend-build

      # Docker build (only on main branch)
      - docker-build:
          requires:
            - python-test
            - frontend-build
          filters:
            branches:
              only:
                - main
                - develop

  # Nightly security scan
  nightly-security:
    triggers:
      - schedule:
          cron: "0 2 * * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - python-security
