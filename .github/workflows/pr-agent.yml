name: PR Agent Workflow

permissions:
  contents: read

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

jobs:
  pr-agent-trigger:
    permissions:
      issues: write
      pull-requests: read
    if: |
      (github.event_name == 'pull_request_review' && github.event.review.state == 'changes_requested') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@copilot'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Fetch PR context
        id: context
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number || github.event.issue.number }}
          if [ -z "${PR_NUMBER}" ]; then
           echo "::error::Could not determine PR number"
           exit 1
          fi
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/${PR_NUMBER} \
            --jq '{number: .number, title: .title, body: .body, changed_files: .changed_files, additions: .additions, deletions: .deletions}')
          REVIEWS=$(gh api repos/${{ github.repository }}/pulls/${PR_NUMBER}/reviews \
            --jq '[.[] | select(.state == "changes_requested") | {user: .user.login, body: .body}]')
          ACTION_ITEMS=$(echo "${REVIEWS}" | jq -r '.[].body' | grep -oE "(fix|add|update|remove|refactor)[^.]*" | head -5 | tr '\n' ',' | sed 's/,$//' || echo "general_improvements")
          echo "action_items=${ACTION_ITEMS}" >> $GITHUB_OUTPUT

      - name: Create PR comment
        uses: actions/github-script@v7
        env:
          ACTION_ITEMS: ${{ steps.context.outputs.action_items }}
        with:
          script: |
            const actionItems = process.env.ACTION_ITEMS;
            const statusMessage = `ü§ñ PR Agent Status Update\n\n` +
              `**Review Analysis Complete**\n` +
              `- üìù Action items identified: ${actionItems}\n\n` +
              `**Next Steps:**\n` +
              `- Implementing requested changes\n` +
              `- Will update PR when complete\n` +
              `- Re-review will be requested automatically\n\n` +
              `*Automated by PR Agent Workflow*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: statusMessage
            });
